<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Desktop Sign-In</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #050505;
      color: #fff;
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }

    .card {
      max-width: 520px;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Desktop sign-in</h1>
    <p id="status">Preparing desktop sign-in…</p>
    <p>If this page stays open, close it and restart from the desktop app.</p>
  </div>

  <script type="module">
    const statusEl = document.getElementById('status');
    const setStatus = (msg) => {
      if (statusEl) statusEl.textContent = msg;
    };

    const params = new URLSearchParams(window.location.search);
    const port = params.get('port');
    const state = params.get('state') || '';
    const providerParam = params.get('provider') || 'google';

    if (!port) {
      setStatus('Missing desktop session details. Close this tab and try again.');
      throw new Error('Missing port parameter.');
    }

    const firebaseConfig = window.FIREBASE_CONFIG || {};
    const requiredKeys = [
      'apiKey',
      'authDomain',
      'projectId',
      'storageBucket',
      'messagingSenderId',
      'appId',
    ];
    const hasConfig = requiredKeys.every((key) => firebaseConfig[key]);
    if (!hasConfig) {
      setStatus('Desktop sign-in misconfigured. Contact support.');
      throw new Error('Missing Firebase config on desktop auth page.');
    }

    const script = document.createElement('script');
    script.src = 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js';
    script.onload = () => {
      const authScript = document.createElement('script');
      authScript.src = 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js';
      authScript.onload = init;
      document.head.appendChild(authScript);
    };
    document.head.appendChild(script);

    async function init() {
      const app = firebase.initializeApp(firebaseConfig, 'desktop-auth');
      const auth = firebase.auth(app);

      const unsubscribe = auth.onAuthStateChanged((user) => {
        if (!user) {
          if (!window.__redirectStarted) {
            window.__redirectStarted = true;
            setStatus('Redirecting to Google sign-in…');
            launchRedirect(auth);
          }
          return;
        }
        finishWithCredential(user);
      });

      window.addEventListener('beforeunload', () => {
        unsubscribe?.();
      });

      try {
        const result = await auth.getRedirectResult();
        if (result?.user) {
          finishWithCredential(result.user, result);
        }
      } catch (err) {
        console.error('Desktop redirect result error', err);
        setStatus(err?.message || 'Failed to resume desktop sign-in. Close this tab and try again.');
      }
    }

    function launchRedirect(auth) {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('email');
      auth
        .signInWithRedirect(provider)
        .catch((err) => {
          console.error('Desktop auth redirect launch failed', err);
          setStatus(err?.message || 'Unable to start Google sign-in. Close this tab and try again.');
          window.__redirectStarted = false;
        });
    }

    async function finishWithCredential(user, redirectResult) {
      try {
        const credential =
          redirectResult?.credential ||
          firebase.auth.GoogleAuthProvider.credentialFromResult(redirectResult);

        if (!credential) {
          setStatus('Google credentials missing. Close this tab and try again.');
          return;
        }

        const payload = {
          version: 1,
          provider: providerParam,
          uid: user.uid,
          email: user.email || '',
          idToken: credential.idToken || '',
          accessToken: credential.accessToken || '',
          refreshToken: user.refreshToken || '',
          state,
        };

        const encoded = encodeURIComponent(btoa(JSON.stringify(payload)));
        setStatus('Finishing desktop sign-in…');
        window.location.href = `http://127.0.0.1:${port}/cb#desktop=${encoded}`;
      } catch (err) {
        console.error('Desktop auth bridge failed', err);
        setStatus(err?.message || 'Failed to complete desktop sign-in. Close this tab and try again.');
      }
    }
  </script>

  <script>
    window.FIREBASE_CONFIG = {
      apiKey: '%REACT_APP_FIREBASE_API_KEY%',
      authDomain: '%REACT_APP_FIREBASE_AUTH_DOMAIN%',
      projectId: '%REACT_APP_FIREBASE_PROJECT_ID%',
      storageBucket: '%REACT_APP_FIREBASE_STORAGE_BUCKET%',
      messagingSenderId: '%REACT_APP_FIREBASE_MESSAGING_SENDER_ID%',
      appId: '%REACT_APP_FIREBASE_APP_ID%',
      measurementId: '%REACT_APP_FIREBASE_MEASUREMENT_ID%',
    };
  </script>
</body>

</html>